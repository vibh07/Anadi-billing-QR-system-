<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anadi Billing System</title>
    <link rel="icon" type="image/x-icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTpSUECPfnUCAQ0A5l2QBVlZNzlAImCOHl0SA&s">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --secondary-light: #eaf5fb;
            --success-color: #27ae60;
            --success-light: #e6f7ee;
            --danger-color: #c0392b;
            --danger-light: #fbe9e7;
            --warning-color: #f39c12;
            --light-gray: #f4f6f9;
            --white: #ffffff;
            --dark-text: #34495e;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-text);
            line-height: 1.6;
        }
        #login-page {
            display: flex; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg, #34495e, #2c3e50);
            overflow: hidden; position: relative;
        }
        .background-shapes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .background-shapes li {
            position: absolute; display: block; list-style: none;
            width: 20px; height: 20px; background: rgba(255, 255, 255, 0.1);
            animation: animateShapes 25s linear infinite; bottom: -150px;
        }
        .background-shapes li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .background-shapes li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .background-shapes li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .background-shapes li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .background-shapes li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .background-shapes li:nth-child(6){ left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .background-shapes li:nth-child(7){ left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .background-shapes li:nth-child(8){ left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .background-shapes li:nth-child(9){ left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .background-shapes li:nth-child(10){ left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }
        @keyframes animateShapes {
            0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; }
            100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; }
        }
        #login-box {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            padding: 1.5rem 2rem; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            text-align: center; width: 90%; max-width: 400px; z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideFadeIn 0.8s ease-out forwards; opacity: 0;
        }
        @keyframes slideFadeIn {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #login-box h1 { color: var(--primary-color); margin-bottom: 2.5rem; font-weight: 600; font-size: 2rem; }
        .input-field { position: relative; margin-bottom: 2rem; }
        .input-field input {
            width: 100%; padding: 1rem 1rem 0.5rem 2.5rem; border: none;
            border-bottom: 2px solid #ccc; background: transparent;
            font-size: 1rem; color: var(--dark-text); outline: none; transition: border-color 0.3s;
        }
        .input-field .icon { position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: #888; transition: color 0.3s; }
        .input-field input:focus ~ .icon,
        .input-field input:not(:placeholder-shown) ~ .icon { color: var(--secondary-color); }
        .input-field label {
            position: absolute; top: 0.8rem; left: 2.5rem; color: #999;
            font-size: 1rem; pointer-events: none; transition: all 0.3s ease;
        }
        .input-field input:focus + label,
        .input-field input:not(:placeholder-shown) + label { top: -10px; font-size: 0.8rem; color: var(--secondary-color); }
        .input-field input:focus { border-bottom-color: var(--secondary-color); }
        .btn { padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; border-radius: var(--border-radius); color: white; transition: all 0.3s ease; width: 100%; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.25); }
        .btn-primary {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            background-size: 200% 100%; transition: background-position 0.5s ease;
        }
        .btn-primary:hover { background-position: 100% 0; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-warning { background-color: var(--warning-color); }
        #main-page { display: none; }
        header {
            background-color: #ffffff; color: var(--primary-color); padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); position: sticky; top: 0; z-index: 100;
        }
        header h2 { font-weight: 600; }
        nav button { background: none; border: 2px solid var(--primary-color); color: var(--primary-color); padding: 0.5rem 1rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        nav button.active, nav button:hover { background: var(--primary-color); color: var(--white); }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .tab { display: none; }
        .tab.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-section { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem; box-shadow: var(--shadow); }
        .form-section h3 { margin-top: 0; font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--light-gray); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .product-entry-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; align-items: end;}
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.8rem; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        thead { background-color: #f8f9fa; }
        .action-buttons-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .action-buttons-container .btn { width: auto; flex-grow: 1; }
        #qr-and-print-section { text-align: center; margin-top: 2rem; padding: 2rem; background: var(--white); border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .history-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; align-items: center; }
        #historySearchInput { flex: 1 1 300px; padding: 0.8rem; font-size: 1rem; border-radius: var(--border-radius); border: 1px solid #ccc; }
        .history-controls button { flex: 1 1 150px; width: auto; }
        .bill-card { border-radius: var(--border-radius); margin-bottom: 1rem; box-shadow: var(--shadow); border-left: 5px solid; transition: all 0.3s ease; }
        .bill-card.pending { border-color: var(--danger-color); background-color: var(--danger-light); }
        .bill-card.dispatched { border-color: var(--success-color); background-color: var(--success-light); }
        .bill-header { padding: 0rem 0.5rem; display: flex; flex-wrap: wrap; gap: 0rem; align-items: center; cursor: pointer;justify-content: flex-end; }
        .bill-header > div { flex: 1 1 150px; }
        .bill-header p { margin: 0; font-size: 0.9rem; }
        .bill-header p strong { font-size: 1.2rem; color: var(--primary-color); }
        .bill-header .bill-actions { flex-grow: 0; display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; }
        .action-btn {
            background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
            width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s;
        }
        .action-btn svg { width: 20px; height: 20px; }
        .action-btn.whatsapp-btn { background-color: #e8f5e9; color: #25d366; }
        .action-btn.whatsapp-btn:hover { background-color: #25d366; color: white; }
        .action-btn.delete-btn { background-color: var(--danger-light); color: var(--danger-color); }
        .action-btn.delete-btn:hover { background-color: var(--danger-color); color: white; }
        .action-btn.expand-btn { background-color: var(--secondary-light); color: var(--secondary-color); transition: transform 0.3s; }
        .action-btn.expand-btn.expanded { transform: rotate(180deg); }
        .bill-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .bill-details-content { padding: 0 1.5rem 1.5rem; border-top: 1px dashed #ccc; }
        .payment-status { font-weight: bold; padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.8em; }
        .payment-status.paid { background-color: var(--success-color); }
        .payment-status.unpaid { background-color: var(--warning-color); }
        .payment-toggle-container { display: flex; align-items: center; justify-content: center; margin-left: 10px; }
        .payment-toggle { opacity: 0; width: 0; height: 0; }
        .payment-toggle-label {
            cursor: pointer; width: 50px; height: 26px; background: var(--danger-color); display: block;
            border-radius: 100px; position: relative; transition: background-color 0.2s;
        }
        .payment-toggle-label:after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px;
            background: #fff; border-radius: 90px; transition: 0.2s;
        }
        .payment-toggle:checked + .payment-toggle-label { background: var(--success-color); }
        .payment-toggle:checked + .payment-toggle-label:after { left: calc(100% - 2px); transform: translateX(-100%); }
        @media (min-width: 768px) {
            .form-grid { grid-template-columns: 1fr 1fr; }
            .customer-grid { grid-template-columns: 1fr 1fr 1fr; }
            .product-entry-grid { grid-template-columns: 3fr 1fr 1fr auto; }
        }
        @media (min-width: 992px) {
            .bill-header { justify-content: space-between; }
            .bill-header .bill-actions { order: 1; flex-grow: 0; }
            .bill-header .bill-info-id,
            .bill-header .bill-info-customer,
            .bill-header .bill-info-total { order: 2; }
            .bill-header .bill-info-customer { text-align: center; }
            .bill-header .bill-info-total { text-align: right; }
        }
        .print-only { display: none; }
        @media print {
    /* Define the page size to 4x6 inches */
    @page {
        size: 4in 6in;
        margin: 0.25in; /* आप अपनी ज़रूरत के हिसाब से मार्जिन बदल सकते हैं */
    }

    /* Hide everything that is not meant for printing */
    body > .no-print { display: none !important; }
    .print-only { display: block !important; }

    /* Style the printable area to fit the 4x6 page */
    #printable-area {
        width: 100%;
        height: 100%;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #000;
    }
    
    #print-content {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    #print-content h2 {
        text-align: center;
        margin: 10px 0 5px 0;
        font-size: 16pt;
        font-weight: bold;
    }
    
     #print-content h3 {
        text-align: right;
        margin: 20px 0;
        font-size: 18pt;
        font-weight: bold;
    }
    
    #print-content p {
        margin: 4px 0;
        font-size: 10pt;
    }
    
    #print-cust-details {
        margin-bottom: 15px;
    }

    #print-content table {
        width: 100%;
        font-size: 10pt;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    #print-content table th, #print-content table td {
        padding: 6px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    #print-content table th {
        font-weight: bold;
        background-color: #f4f4f4;
    }
    
    #print-total {
        font-size: 16pt !important;
    }
    
    #print-qr-img {
        max-width: 130px; /* QR code का आकार */
        margin: 20px auto 10px auto;
        display: block;
    }
    
    .center {
        text-align: center;
    }
}
        #dispatchModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; text-align: center; }
        /* Simple style for the QR Reader div */
        #qr-reader {
            border: 2px dashed #ccc;
            margin-bottom: 1rem;
        }
        .manual-dispatch-box { display: flex; gap: 10px; margin-top: 20px; }
        .manual-dispatch-box input { flex-grow: 1; }
        #toastContainer {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .toast {
            color: white; font-weight: 600; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius); width: 350px; overflow: hidden;
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        @keyframes line-to-box-in {
            0% { max-height: 0; width: 0; padding: 0; opacity: 0; border-radius: 0; }
            30% { max-height: 2px; width: 350px; padding: 0; opacity: 1; border-radius: 0; }
            100% { max-height: 100px; width: 350px; padding: 1rem 1.5rem; opacity: 1; }
        }
        @keyframes line-to-box-out {
            0% { max-height: 100px; padding: 1rem 1.5rem; opacity: 1; }
            70% { max-height: 2px; padding: 0; opacity: 1; overflow: hidden; }
            100% { max-height: 2px; width: 0; padding: 0; opacity: 0; overflow: hidden; }
        }
    </style>
</head>
<body>
    <div id="login-page" class="no-print">
        <ul class="background-shapes">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div id="login-box">
            <h1>Billing System Login</h1>
            <div class="input-field">
                <input type="text" id="username" required placeholder=" ">
                <label for="username">Enter Your Name</label>
                <span class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg>
                </span>
            </div>
            <div class="input-field">
                <input type="password" id="password" required placeholder=" ">
                <label for="password">Enter Password</label>
                <span class="icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 9a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1z"/></svg>
                </span>
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Login</button>
        </div>
    </div>
    
    <div id="main-page" class="no-print">
        <header>
            <h2>Anadi Billing System</h2>
            <nav>
                <button id="nav-billing" class="active" onclick="showTab('billing')">Billing</button>
                <button id="nav-history" onclick="showTab('history')">History</button>
            </nav>
        </header>
        <div class="container">
            <div id="billing-tab" class="tab active">
                 <div class="form-section">
                    <h3>Customer Details</h3>
                    <div class="form-grid customer-grid">
                        <input type="text" id="cust-name" placeholder="Name">
                        <input type="tel" id="cust-phone" placeholder="Phone Number">
                        <input type="text" id="cust-house" placeholder="House No / Address">
                    </div>
                </div>
                <div class="form-section">
                    <h3>Product Details</h3>
                    <div class="product-entry-grid">
                        <input type="text" id="product-name" placeholder="Product Name">
                        <input type="number" id="product-qty" placeholder="Qty" min="0.001" step="0.001">
                        <input type="number" id="product-price" placeholder="Price" min="0">
                        <button class="btn btn-secondary" onclick="addItemToCart()">Add Item</button>
                    </div>
                    <table id="cart-table">
                        <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="action-buttons-container">
                    <button class="btn btn-warning" onclick="clearCart()">Clear Cart</button>
                    <button class="btn btn-success" onclick="generateBill()">Generate Bill & QR</button>
                </div>
               <div id="qr-and-print-section" style="display: none;">
    <h2 id="bill-id-display"></h2>
    <div id="qrcode"></div>
    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
        <button class="btn btn-primary" onclick="window.print()">Print Bill</button>
        <button class="btn btn-secondary" onclick="saveAsPdf()">Save as PDF</button>
    </div>
</div>
            </div>

            <div id="history-tab" class="tab">
                <div class="history-controls form-section">
                     <input type="text" id="historySearchInput" placeholder="Search by Name, Phone, or Bill ID..." oninput="renderHistory()">
                     <button class="btn btn-primary" onclick="openDispatchModal()">Update Status</button>
                     <button class="btn btn-secondary" onclick="exportFormattedExcel()">Export to Excel</button>
                </div>
                <div id="bill-history-container"></div>
            </div>
        </div>
    </div>

    <div id="printable-area" class="print-only">
        <div id="print-content">
             <h2>Anadi Industries LLP</h2>
             <p class="center"> Sohna Road Opp Haryana Gramin Bank Village Pali Faridabad Haryana 121004</p>
             <hr>
             <div id="print-cust-details"></div>
             <hr>
             <table id="print-items-table"></table>
             <hr>
             <h3 id="print-total"></h3>
             <img id="print-qr-img" alt="QR Code">
             <p class="center">Thank you for your visit!</p>
        </div>
    </div>
    
    <div id="dispatchModal" class="no-print">
        <div class="modal-content">
            <h2>Update Bill Status</h2>
            <div id="qr-reader" style="width:100%;"></div>
            <div class="manual-dispatch-box">
                <input type="number" class="btn" style="background:white; color:black; border:1px solid #ccc" id="billIdInput" placeholder="Or Enter Code Manually">
                <button class="btn btn-success" onclick="handleManualDispatch()">Dispatch</button>
            </div><br>
            <button class="btn btn-danger" onclick="closeDispatchModal()">Close</button>
        </div>
    </div>

    <div id="toastContainer" class="no-print"></div>

   <script>
    let cart = [], bills = [], html5QrCode, currentBill = null; // Added currentBill variable
    const whatsappIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.75,13.96C17.08,14.39 17.21,15.04 17.04,15.54C16.87,16.03 16.46,16.35 15.98,16.5C15.5,16.65 14.88,16.63 14.24,16.39C13.6,16.15 12.38,15.61 11.23,14.45C9.88,13.1 9.05,11.56 8.84,10.93C8.64,10.3 8.8,9.7 9.09,9.29C9.33,8.95 9.68,8.76 10,8.76C10.33,8.76 10.5,8.76 10.63,8.76C10.85,8.76 11.03,8.81 11.21,9.23L11.75,10.5C11.9,10.88 11.91,11.21 11.8,11.48C11.68,11.75 11.53,11.9 11.28,12.15C11.04,12.4 10.9,12.54 10.76,12.68C10.63,12.82 10.48,13.01 10.75,13.28C11.02,13.55 11.63,14.15 12.28,14.81C13.11,15.63 13.75,15.94 14.05,16.09C14.35,16.24 14.58,16.21 14.78,16.03L15.3,15.5C15.68,15.13 16.11,15 16.5,15.03C16.88,15.06 17.63,15.33 17.63,15.33L18.03,13.93C17.76,13.81 17.26,13.55 16.75,13.96M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22C13.66,22 15.25,21.54 16.65,20.73L21.35,22.14L20.06,17.5C21.06,16 21.75,14.11 21.94,12.1C22,11.95 22,11.97 22,12A10,10 0 0,0 12,2Z"/></svg>`;

    document.addEventListener('DOMContentLoaded', () => loadBills());

    function handleLogin() {
        const username = document.getElementById('username').value, password = document.getElementById('password').value;
        if (!username.trim()) return showToast("Please enter your name", "error");
        if (password === "anadi") {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            showToast(`Welcome, ${username}!`);
        } else { showToast("Incorrect Password", "error"); }
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`nav-${tabId}`).classList.add('active');
        if (tabId === 'history') renderHistory();
    }

    function addItemToCart() {
        const name = document.getElementById('product-name').value.trim(),
            qty = parseFloat(document.getElementById('product-qty').value),
            price = parseFloat(document.getElementById('product-price').value);
        if (!name || isNaN(qty) || isNaN(price) || qty <= 0 || price < 0) return showToast("Please fill all product fields correctly", "error");
        cart.push({ name, qty, price, total: qty * price });
        updateCartTable();
        document.getElementById('product-name').value = '';
        document.getElementById('product-qty').value = '';
        document.getElementById('product-price').value = '';
    }

    function updateCartTable() {
        const tbody = document.querySelector('#cart-table tbody');
        tbody.innerHTML = ''; let grandTotal = 0;
        cart.forEach((item) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>₹${item.price.toFixed(2)}</td><td>₹${item.total.toFixed(2)}</td>`;
            tbody.appendChild(row);
            grandTotal += item.total;
        });
        if (cart.length > 0) {
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = "bold";
            totalRow.innerHTML = `<td colspan="3">Grand Total</td><td>₹${grandTotal.toFixed(2)}</td>`;
            tbody.appendChild(totalRow);
        }
    }

    function clearCart() {
        if (cart.length > 0 && confirm("Are you sure you want to clear the entire cart?")) {
            cart = [];
            updateCartTable();
            showToast("Cart cleared!", "error");
        }
    }

    async function generateBill() {
        const custName = document.getElementById('cust-name').value.trim(),
            custPhone = document.getElementById('cust-phone').value.trim(),
            custHouse = document.getElementById('cust-house').value.trim();
        if (!custName || !custPhone || !custHouse) return showToast("Please fill customer details", "error");
        if (cart.length === 0) return showToast("Cart is empty", "error");

        const bill = {
            id: Math.floor(1000 + Math.random() * 9000),
            customer: { name: custName, phone: custPhone, house: custHouse },
            items: [...cart],
            total: cart.reduce((sum, item) => sum + item.total, 0),
            date: new Date().toLocaleString('en-IN', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'}),
            status: 'pending',
            paymentStatus: 'unpaid'
        };
        
        currentBill = bill; // Store the generated bill for PDF creation
        bills.unshift(bill);
        saveBills();
        
        try {
            const canvas = await QRCode.toCanvas(document.createElement('canvas'), JSON.stringify({ billId: bill.id }));
            document.getElementById('qrcode').innerHTML = '';
            document.getElementById('qrcode').appendChild(canvas);
            preparePrintableArea(bill, canvas.toDataURL());
        } catch (err) {
            console.error(err);
            return showToast("Failed to generate QR Code", "error");
        }
        
        document.getElementById('bill-id-display').innerText = `Unique Code: ${bill.id}`;
        document.getElementById('qr-and-print-section').style.display = 'block';
        showToast(`Bill #${bill.id} Generated & Saved!`);
        cart = []; updateCartTable();
        ['cust-name', 'cust-phone', 'cust-house'].forEach(id => document.getElementById(id).value = '');
    }
    
    // --- NEW FUNCTION TO SAVE BILL AS PDF ---
    // --- UPDATED FUNCTION TO SAVE BILL AS PDF ---
    function saveAsPdf() {
        if (!currentBill) {
            showToast("No bill has been generated to save.", "error");
            return;
        }

        const { jsPDF } = window.jspdf;
        // Initialize PDF for 4x6 inch paper
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'in',
            format: [4, 6]
        });

        const margin = 0.25;
        const pageWidth = 4;
        const pageHeight = 6;
        const contentWidth = pageWidth - (margin * 2);
        let y = margin + 0.1;

        // --- Header ---
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('Anadi Industries LLP', pageWidth / 2, y, { align: 'center' });
        y += 0.2;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        const address = 'Sohna Road Opp Haryana Gramin Bank Village Pali Faridabad Haryana 121004';
        doc.text(address, pageWidth / 2, y, { align: 'center', maxWidth: contentWidth });
        y += 0.25;
        doc.setLineWidth(0.01);
        doc.line(margin, y, pageWidth - margin, y);
        y += 0.2;

        // --- Customer Details ---
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('Bill To:', margin, y);
        doc.setFont('helvetica', 'normal');
        doc.text(currentBill.customer.name, margin + 0.6, y);
        y += 0.2; // Consistent line height

        doc.setFont('helvetica', 'bold');
        doc.text('Phone:', margin, y);
        doc.setFont('helvetica', 'normal');
        doc.text(currentBill.customer.phone, margin + 0.6, y);
        y += 0.2;
        
        // --- FIX 1: Address and Bill ID Overlapping ---
        doc.setFont('helvetica', 'bold');
        doc.text('Address:', margin, y);
        doc.setFont('helvetica', 'normal');
        // This code now handles multi-line addresses correctly
        const addressLines = doc.splitTextToSize(currentBill.customer.house, contentWidth - 0.7);
        doc.text(addressLines, margin + 0.6, y);
        // Increase space based on the number of lines in the address
        y += (addressLines.length * 0.18); 
        y += 0.1; // Extra padding

        // --- Bill Info ---
        doc.setFont('helvetica', 'bold');
        doc.text(`Bill ID: ${currentBill.id}`, margin, y);
        doc.text(`Date: ${currentBill.date}`, pageWidth - margin, y, { align: 'right' });
        y += 0.2;
        doc.line(margin, y, pageWidth - margin, y);

        // --- Items Table ---
        // --- FIX 2 & 3: Misaligned Amount and Rupee Symbol ---
        const tableHead = [['Item', 'Qty', 'Price (Rs)', 'Amount (Rs)']];
        const tableBody = currentBill.items.map(item => [
            item.name,
            item.qty,
            item.price.toFixed(2), // Symbol removed for correct alignment
            item.total.toFixed(2)  // Symbol removed for correct alignment
        ]);

        doc.autoTable({
            head: tableHead,
            body: tableBody,
            startY: y + 0.1,
            theme: 'grid',
            headStyles: { fillColor: [240, 240, 240], textColor: 20, fontStyle: 'bold' },
            styles: { fontSize: 9, cellPadding: 0.05 },
            columnStyles: {
                1: { halign: 'right' },
                2: { halign: 'right' },
                3: { halign: 'right' },
            },
            margin: { left: margin, right: margin }
        });
        
        y = doc.autoTable.previous.finalY;

        // --- Total ---
        y += 0.3;
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        const totalText = `Grand Total: Rs ${currentBill.total.toFixed(2)}`; // Using "Rs" for compatibility
        doc.text(totalText, pageWidth - margin, y, { align: 'right' });

        // --- QR Code & Footer ---
        const qrImgData = document.getElementById('print-qr-img').src;
        const qrSize = 1.2; 
        const qrX = (pageWidth - qrSize) / 2;
        const qrY = pageHeight - margin - qrSize - 0.3; 
        
        if (y < qrY) {
             doc.addImage(qrImgData, 'PNG', qrX, qrY, qrSize, qrSize);
             doc.setFontSize(9);
             doc.setFont('helvetica', 'italic');
             doc.text('Thank you for your visit!', pageWidth / 2, pageHeight - margin - 0.1, { align: 'center' });
        }

        // --- Save the PDF ---
        doc.save(`bill-${currentBill.id}.pdf`);
        showToast("PDF saved successfully!", "success");
    }

    function preparePrintableArea(bill, qrDataUrl) {
        document.getElementById('print-cust-details').innerHTML = `<p><strong>Bill To:</strong> ${bill.customer.name}</p><p><strong>Phone:</strong> ${bill.customer.phone}</p><p><strong>Address:</strong> ${bill.customer.house}</p><p><strong>Date:</strong> ${bill.date}</p><p><strong>Bill ID:</strong> ${bill.id}</p>`;
        const itemsTbody = bill.items.map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.total.toFixed(2)}</td></tr>`).join('');
        document.getElementById('print-items-table').innerHTML = `<thead><tr><th>Item</th><th>Qty</th><th>Amt</th></tr></thead><tbody>${itemsTbody}</tbody>`;
        document.getElementById('print-total').innerText = `Total: ₹${bill.total.toFixed(2)}`;
        document.getElementById('print-qr-img').src = qrDataUrl;
    }

    function renderHistory() {
        const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
        const filteredBills = bills.filter(bill =>
            bill.customer.name.toLowerCase().includes(searchTerm) ||
            bill.customer.phone.includes(searchTerm) ||
            bill.id.toString().includes(searchTerm)
        );

        const container = document.getElementById('bill-history-container');
        container.innerHTML = filteredBills.length === 0 ? '<p style="text-align:center;">No bills found.</p>' : '';
        
        filteredBills.forEach(bill => {
            const card = document.createElement('div');
            card.className = `bill-card ${bill.status}`;
            card.innerHTML = ` 
                <div class="bill-header" onclick="toggleDetails(this, ${bill.id})"> 
                    <div class="bill-info-id"><p><strong>#${bill.id}</strong><br><small>${bill.status.toUpperCase()}</small></p></div> 
                    <div class="bill-info-customer"><p>${bill.customer.name}<br><small>${bill.customer.phone}</small></p></div> 
                    <div class="bill-info-total">
                        <p>₹${bill.total.toFixed(2)}<br>
                            <span class="payment-status ${bill.paymentStatus}">${bill.paymentStatus.toUpperCase()}</span>
                        </p>
                    </div> 
                    <div class="bill-actions" onclick="event.stopPropagation()">
                        <div class="payment-toggle-container" title="Toggle Payment Status">
                            <input type="checkbox" id="pay-toggle-${bill.id}" class="payment-toggle" onchange="togglePaymentStatus(${bill.id}, this.checked)" ${bill.paymentStatus === 'paid' ? 'checked' : ''}>
                            <label for="pay-toggle-${bill.id}" class="payment-toggle-label"></label>
                        </div>
                        <button class="action-btn whatsapp-btn" title="Send on WhatsApp" onclick="sendWhatsApp(${bill.id})">${whatsappIcon}</button> 
                        <button class="action-btn delete-btn" title="Delete Bill" onclick="deleteBill(${bill.id})">🗑️</button> 
                        <button class="action-btn expand-btn" title="View Details">▼</button> 
                    </div> 
                </div> 
                <div class="bill-details"><div class="bill-details-content"></div></div>`;
            container.appendChild(card);
        });
    }
    
    function toggleDetails(headerElement, billId) {
        const expandBtn = headerElement.querySelector('.expand-btn'), detailsDiv = headerElement.nextElementSibling;
        const isExpanded = detailsDiv.style.maxHeight && detailsDiv.style.maxHeight !== "0px";
        if (isExpanded) {
            detailsDiv.style.maxHeight = "0px";
            expandBtn.classList.remove('expanded');
        } else {
            const bill = bills.find(b => b.id === billId), content = detailsDiv.querySelector('.bill-details-content');
            content.innerHTML = `<p><strong>Address:</strong> ${bill.customer.house}</p><strong>Items:</strong><ul>${bill.items.map(i => `<li>${i.name} (Qty: ${i.qty}) - ₹${i.total.toFixed(2)}</li>`).join('')}</ul>`;
            detailsDiv.style.maxHeight = content.scrollHeight + 40 + "px";
            expandBtn.classList.add('expanded');
        }
    }
    
    function togglePaymentStatus(billId, isChecked) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;

        bill.paymentStatus = isChecked ? 'paid' : 'unpaid';
        saveBills();
        
        const card = document.querySelector(`#pay-toggle-${billId}`).closest('.bill-card');
        const statusSpan = card.querySelector('.payment-status');
        statusSpan.textContent = bill.paymentStatus.toUpperCase();
        statusSpan.className = `payment-status ${bill.paymentStatus}`;

        showToast(`Bill #${billId} marked as ${bill.paymentStatus}.`);
    }

    function handleManualDispatch() {
        const id = parseInt(document.getElementById('billIdInput').value);
        if(isNaN(id)) return showToast("Please enter a valid numeric code", "error");
        markAsDispatched(id);
        document.getElementById('billIdInput').value = '';
    }

    function markAsDispatched(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return showToast(`Bill #${billId} not found.`, "error");
        if (bill.status === 'dispatched') return showToast(`Bill #${billId} is already dispatched.`, "error");
        bill.status = 'dispatched';
        saveBills(); renderHistory();
        showToast(`Bill #${billId} marked as Dispatched!`);
        setTimeout(() => sendWhatsApp(billId), 500);
    }

    function deleteBill(billId) {
        if (confirm(`Are you sure you want to delete bill #${billId}?`)) {
            bills = bills.filter(b => b.id !== billId);
            saveBills(); renderHistory();
            showToast(`Bill #${billId} deleted.`, 'error');
        }
    }
    
    function formatPhoneNumberForWhatsApp(phone) {
        let cleaned = phone.replace(/\D/g, '');
        if (cleaned.startsWith('0')) { cleaned = cleaned.substring(1); }
        if (cleaned.length === 10) { return '91' + cleaned; }
        return cleaned;
    }

    function sendWhatsApp(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        const formattedPhone = formatPhoneNumberForWhatsApp(bill.customer.phone);
        const itemsText = bill.items.map(i => `${i.name} (Qty: ${i.qty}) - ₹${i.total.toFixed(2)}`).join('%0A');
        const message = `*Bill Details*%0A%0ABill ID: *${bill.id}*%0ACustomer: *${bill.customer.name}*%0ADispatch Status: *${bill.status.toUpperCase()}*%0APayment Status: *${bill.paymentStatus.toUpperCase()}*%0A%0A--- Items ---%0A${itemsText}%0A%0ATotal Amount: *₹${bill.total.toFixed(2)}*`;
        window.open(`https://wa.me/${formattedPhone}?text=${message}`, "_blank");
    }
    
    function exportFormattedExcel() {
        if (bills.length === 0) {
            showToast("No bills to export.", "error");
            return;
        }
        let serialNumber = 1, grandTotal = 0;
        const headers = [
            "Sr. No.", "Customer Name", "Phone Number", "Address", "Product Name",
            "Quantity", "Price per Item", "Total Price", "Date", "Dispatch Status", "Payment Status"
        ];
        const reportData = [];
        bills.forEach(bill => {
            bill.items.forEach(item => {
                reportData.push({
                    "Sr. No.": serialNumber++, "Customer Name": bill.customer.name,
                    "Phone Number": bill.customer.phone, "Address": bill.customer.house,
                    "Product Name": item.name, "Quantity": item.qty,
                    "Price per Item": item.price, "Total Price": item.total,
                    "Date": bill.date, "Dispatch Status": bill.status,
                    "Payment Status": bill.paymentStatus
                });
                grandTotal += item.total;
            });
        });
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(reportData, { header: headers });
        const totalRow = { "Price per Item": "Grand Total", "Total Price": grandTotal };
        XLSX.utils.sheet_add_json(worksheet, [totalRow], { skipHeader: true, origin: -1 });
        const columnWidths = headers.map(header => {
            const headerLength = header ? header.length : 10;
            const dataRows = reportData.map(row => String(row[header] || "").length);
            return { wch: Math.max(headerLength, ...dataRows) + 2 };
        });
        if (columnWidths[6].wch < "Grand Total".length + 2) { columnWidths[6].wch = "Grand Total".length + 2; }
        worksheet['!cols'] = columnWidths;
        const range = XLSX.utils.decode_range(worksheet['!ref']);
        worksheet['!autofilter'] = { ref: XLSX.utils.encode_range(range) };
        const priceColIndex = headers.indexOf("Price per Item");
        const totalColIndex = headers.indexOf("Total Price");
        for (let i = 0; i < reportData.length; i++) {
            const priceCell = XLSX.utils.encode_cell({c: priceColIndex, r: i + 1});
            const totalCell = XLSX.utils.encode_cell({c: totalColIndex, r: i + 1});
            if(worksheet[priceCell]) XLSX.utils.cell_set_number_format(worksheet[priceCell], '₹ #,##0.00');
            if(worksheet[totalCell]) XLSX.utils.cell_set_number_format(worksheet[totalCell], '₹ #,##0.00');
        }
        const lastRowIndex = reportData.length + 1;
        const grandTotalTextCell = XLSX.utils.encode_cell({c: priceColIndex, r: lastRowIndex});
        const grandTotalValueCell = XLSX.utils.encode_cell({c: totalColIndex, r: lastRowIndex});
        if(worksheet[grandTotalTextCell]) { worksheet[grandTotalTextCell].s = { font: { bold: true } }; }
        if(worksheet[grandTotalValueCell]) {
            worksheet[grandTotalValueCell].s = { font: { bold: true }, numFmt: '₹ #,##0.00' };
        }
        XLSX.utils.book_append_sheet(workbook, worksheet, "Bill Report");
        XLSX.writeFile(workbook, `Formatted_Bill_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        showToast("Formatted Excel export with totals started!");
    }

    function saveBills() { localStorage.setItem('anadiBills', JSON.stringify(bills)); }
    function loadBills() { bills = JSON.parse(localStorage.getItem('anadiBills') || '[]'); }
    
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toast.style.animation = 'line-to-box-in 0.6s ease-out forwards';
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'line-to-box-out 0.6s ease-in forwards';
            setTimeout(() => { toast.remove(); }, 600);
        }, 4400);
    }

    function openDispatchModal() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Failed to stop previous scanner.", err));
        }

        document.getElementById('dispatchModal').style.display = 'block';
        
        html5QrCode = new Html5Qrcode("qr-reader");
        
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            try {
                const data = JSON.parse(decodedText);
                if (data.billId) {
                    markAsDispatched(data.billId);
                    closeDispatchModal();
                } else {
                    showToast("QR code does not contain a Bill ID.", "error");
                }
            } catch (e) {
                showToast("Invalid QR Code format.", "error");
            }
        };

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .catch((err) => {
                console.error("Could not start QR scanner", err);
                const qrReaderDiv = document.getElementById('qr-reader');
                qrReaderDiv.innerHTML = '<p style="color: red; font-weight: bold;">Could not start camera. Please make sure you are on a secure (https) connection and have granted camera permissions.</p>';
            });
    }

    function closeDispatchModal() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch((err) => {
                console.error("Failed to stop QR code scanner.", err);
            });  
        }
        document.getElementById('dispatchModal').style.display = 'none';
    }
</script>
</body>
</html>
