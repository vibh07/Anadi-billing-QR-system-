<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anadi Billing System</title>
    <link rel="icon" type="image/x-icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTpSUECPfnUCAQ0A5l2QBVlZNzlAImCOHl0SA&s">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --info-color: #1abc9c;
            --secondary-light: #eaf5fb;
            --success-color: #27ae60;
            --success-light: #e6f7ee;
            --danger-color: #c0392b;
            --danger-light: #fbe9e7;
            --warning-color: #f39c12;
            --light-gray: #f4f6f9;
            --white: #ffffff;
            --dark-text: #34495e;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --border-radius: 8px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        * { box-sizing: border-box; margin: 0 ; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-text);
            line-height: 1.6;
        }
        #login-page {
            display: flex; justify-content: center; align-items: center;
            height: 100vh; background: linear-gradient(135deg, #34495e, #2c3e50);
            overflow: hidden; position: relative;
        }
        .background-shapes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .background-shapes li {
            position: absolute; display: block; list-style: none;
            width: 20px; height: 20px; background: rgba(255, 255, 255, 0.1);
            animation: animateShapes 25s linear infinite; bottom: -150px;
        }
        .background-shapes li:nth-child(1){ left: 25%; width: 80px; height: 80px; animation-delay: 0s; }
        .background-shapes li:nth-child(2){ left: 10%; width: 20px; height: 20px; animation-delay: 2s; animation-duration: 12s; }
        .background-shapes li:nth-child(3){ left: 70%; width: 20px; height: 20px; animation-delay: 4s; }
        .background-shapes li:nth-child(4){ left: 40%; width: 60px; height: 60px; animation-delay: 0s; animation-duration: 18s; }
        .background-shapes li:nth-child(5){ left: 65%; width: 20px; height: 20px; animation-delay: 0s; }
        .background-shapes li:nth-child(6){ left: 75%; width: 110px; height: 110px; animation-delay: 3s; }
        .background-shapes li:nth-child(7){ left: 35%; width: 150px; height: 150px; animation-delay: 7s; }
        .background-shapes li:nth-child(8){ left: 50%; width: 25px; height: 25px; animation-delay: 15s; animation-duration: 45s; }
        .background-shapes li:nth-child(9){ left: 20%; width: 15px; height: 15px; animation-delay: 2s; animation-duration: 35s; }
        .background-shapes li:nth-child(10){ left: 85%; width: 150px; height: 150px; animation-delay: 0s; animation-duration: 11s; }
        @keyframes animateShapes {
            0%{ transform: translateY(0) rotate(0deg); opacity: 1; border-radius: 0; }
            100%{ transform: translateY(-1000px) rotate(720deg); opacity: 0; border-radius: 50%; }
        }
        #login-box {
            background: rgb(232 240 254); backdrop-filter: blur(7px);
             padding: 1.5rem 2rem; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
            text-align: center; width: 90%; max-width: 400px; z-index: 2;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideFadeIn 0.8s ease-out forwards; opacity: 0;
        }
        @keyframes slideFadeIn {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #login-box h1 { color: #324559;
    margin-bottom: 1.5rem;
    font-weight: 600;
    font-size: 1.6rem; }
        .input-field { position: relative; margin-bottom: 2rem; }
        .input-field input {
            width: 100%; padding: 1rem 1rem 0.5rem 2.5rem; border: none;
            border-bottom: 2px solid #ccc; background: transparent;
            font-size: 1rem; color: var(--dark-text); outline: none; transition: border-color 0.3s;
        }
        .input-field .icon { position: absolute; left: 0; top: 50%; transform: translateY(-50%); color: #888; transition: color 0.3s; }
        .input-field input:focus ~ .icon,
        .input-field input:not(:placeholder-shown) ~ .icon { color: var(--secondary-color); }
        .input-field label {
            position: absolute; top: 0.8rem; left: 2.5rem; color: #999;
            font-size: 1rem; pointer-events: none; transition: all 0.3s ease;
        }
        .input-field input:focus + label,
        .input-field input:not(:placeholder-shown) + label { top: -10px; font-size: 0.8rem; color: var(--secondary-color); }
        .input-field input:focus { border-bottom-color: var(--secondary-color); }
        .btn { padding: 0.8rem 1.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; border-radius: var(--border-radius); color: white; transition: all 0.3s ease; width: 100%; }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.25); }
        .btn-primary {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            background-size: 200% 100%; transition: background-position 0.5s ease;
        }
        .btn-primary:hover { background-position: 100% 0; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-warning { background-color: var(--warning-color); }
        .btn-info { background-color: var(--info-color); }

        #main-page { display: none; }
        header {
            background-color: #ffffff; color: var(--primary-color); padding: 1rem 2rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); position: sticky; top: 0; z-index: 100;
        }
        header h2 { font-weight: 1000; }
        nav button { background: none; border: 2px solid var(--primary-color); color: var(--primary-color); padding: 0.5rem 1rem; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        nav button.active, nav button:hover { background: var(--primary-color); color: var(--white); }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .tab { display: none; }
        .tab.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .form-section { background: var(--white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem; box-shadow: var(--shadow); }
        .form-section h3 { margin-top: 0; font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--light-gray); padding-bottom: 0.5rem; margin-bottom: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        .product-entry-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; align-items: end;}
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 0.8rem; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        thead { background-color: #f8f9fa; }
        .action-buttons-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
        .action-buttons-container .btn { width: auto; flex-grow: 1; }
        .history-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; align-items: center; }
        #historySearchInput { flex: 1 1 300px; padding: 0.8rem; font-size: 1rem; border-radius: var(--border-radius); border: 1px solid #ccc; }
        
        /* MODIFIED */
        .history-controls .controls-group {
            display: flex;
            gap: 1rem;
        }
        .history-controls .action-btn {
            flex-shrink: 0;
        }
        
        .bill-card {
            background-color: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            border-left: 5px solid;
            overflow: hidden;
        }
        .bill-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .bill-card.pending { border-color: var(--warning-color); }
        .bill-card.dispatched { border-color: var(--success-color); }

        .bill-card-main {
                display: flex
;
    align-items: center;
    padding: -2rem 1.5rem;
    cursor: pointer;
    flex-wrap: nowrap;
        }
        .bill-info { flex: 1 1 200px; padding: 0.5rem; }
        .bill-info.bill-id { flex-grow: 0.5; }
        .bill-info.bill-customer { flex-grow: 1.5; }
        .bill-info.bill-total { flex-grow: 0.5; text-align: right; }

        .bill-info h4 { font-size: 1.5rem; font-weight: 600; color: var(--primary-color); margin: 0; }
        .bill-info p { margin: 0; color: #7f8c8d; }

        .bill-status-badge {
            display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px;
            font-size: 0.8rem; font-weight: 600; color: var(--white); text-transform: uppercase;
        }
        .bill-status-badge.pending { background-color: var(--warning-color); }
        .bill-status-badge.dispatched { background-color: var(--success-color); }

        .bill-card-actions {
            display: flex; justify-content: flex-end; align-items: center;
            gap: 0.5rem; padding: 0.75rem 1.5rem; background-color: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .action-btn {
            background: rgba(0,0,0,0.05); border: none; font-size: 1.2rem; cursor: pointer;
            width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            transition: all 0.2s; color: var(--dark-text);
        }
        .action-btn svg { width: 20px; height: 20px; }
        .action-btn:hover { background-color: rgba(0,0,0,0.1); }
        .action-btn.whatsapp-btn { background-color: #e8f5e9; color: #25d366; }
        .action-btn.whatsapp-btn:hover { background-color: #25d366; color: white; }
        .action-btn.delete-btn { background-color: var(--danger-light); color: var(--danger-color); }
        .action-btn.delete-btn:hover { background-color: var(--danger-color); color: white; }
        .action-btn.expand-btn { background-color: var(--secondary-light); color: var(--secondary-color); transition: transform 0.3s; }
        .action-btn.expand-btn.expanded { transform: rotate(180deg); }

        .bill-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; background: #fafafa; }
        .bill-details-content { padding: 1.5rem; border-top: 1px dashed #ccc; }

        .payment-status { font-weight: bold; padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.8em; }
        .payment-status.paid { background-color: var(--success-color); }
        .payment-status.unpaid { background-color: var(--warning-color); }
        
        .payment-toggle-container { display: flex; align-items: center; margin-right: auto; }
        .payment-toggle-container span { font-size: 0.9rem; margin-right: 10px; font-weight: 600; }
        .payment-toggle { opacity: 0; width: 0; height: 0; }
        .payment-toggle-label {
            cursor: pointer; width: 50px; height: 26px; background: var(--danger-color); display: block;
            border-radius: 100px; position: relative; transition: background-color 0.2s;
        }
        .payment-toggle-label:after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px;
            background: #fff; border-radius: 90px; transition: 0.2s;
        }
        .payment-toggle:checked + .payment-toggle-label { background: var(--success-color); }
        .payment-toggle:checked + .payment-toggle-label:after { left: calc(100% - 2px); transform: translateX(-100%); }
        
        @media (min-width: 768px) {
            .form-grid { grid-template-columns: 1fr 1fr; }
            .customer-grid { grid-template-columns: 1fr 1fr 1fr; }
            .product-entry-grid { grid-template-columns: 3fr 1fr 1fr auto; }
        }

        .print-only { display: none; }
        @media print {
            @page { size: 4in 6in; margin: 0.25in; }
            body > .no-print { display: none !important; }
            .print-only { display: block !important; }
            #printable-area { width: 100%; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #000; }
            #print-content { width: 100%; height: 100%; padding: 0; margin: 0; display: flex; flex-direction: column; }
            #print-content h2 { text-align: center; margin: 10px 0 5px 0; font-size: 16pt; font-weight: bold; }
            #print-content h3 { text-align: right; margin: 20px 0; font-size: 18pt; font-weight: bold; }
            #print-content p { margin: 4px 0; font-size: 10pt; }
            #print-cust-details { margin-bottom: 15px; }
            #print-content table { width: 100%; font-size: 10pt; border-collapse: collapse; margin-top: 15px; }
            #print-content table th, #print-content table td { padding: 6px; text-align: left; border-bottom: 1px solid #ddd; }
            #print-content table th { font-weight: bold; background-color: #f4f4f4; }
            #print-total { font-size: 16pt !important; }
            #print-qr-img { max-width: 130px; margin: 20px auto 10px auto; display: block; }
            .center { text-align: center; }
        }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: #fefefe; margin: 10% auto; padding: 25px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            border-radius: var(--border-radius); text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-content.modal-lg { max-width: 800px; }
        .close-btn {
            position: absolute; top: 10px; right: 15px;
            color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus { color: black; }
        
        #qr-reader { border: 2px dashed #ccc; margin-bottom: 1rem; }
        .manual-dispatch-box { display: flex; gap: 10px; margin-top: 20px; }
        .manual-dispatch-box input { flex-grow: 1; }
        
        #toastContainer {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .toast {
            color: white; font-weight: 600; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius); width: 350px; overflow: hidden;
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        @keyframes line-to-box-in {
            0% { max-height: 0; width: 0; padding: 0; opacity: 0; border-radius: 0; }
            30% { max-height: 2px; width: 350px; padding: 0; opacity: 1; border-radius: 0; }
            100% { max-height: 100px; width: 350px; padding: 1rem 1.5rem; opacity: 1; }
        }
        @keyframes line-to-box-out {
            0% { max-height: 100px; padding: 1rem 1.5rem; opacity: 1; }
            70% { max-height: 2px; padding: 0; opacity: 1; overflow: hidden; }
            100% { max-height: 2px; width: 0; padding: 0; opacity: 0; overflow: hidden; }
        }
        #login-logo { width: 205px; margin-bottom: -2rem; }

        #summary-list-container {
            max-height: 60vh; overflow-y: auto;
            text-align: left; margin-top: 1.5rem;
        }
        .summary-item {
            display: flex; align-items: center; padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-info { flex-grow: 1; }
        .summary-info p { margin: 0; line-height: 1.4; }
        .summary-total { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-right: 1rem; }
        /* ADD THIS NEW CSS FOR THE ENHANCED SUMMARY MODAL */
#summary-list-container {
    max-height: 70vh;
    overflow-y: auto;
    text-align: left;
    margin-top: 1.5rem;
    padding: 0 10px;
}

.summary-card {
    background-color: var(--white);
    border-radius: var(--border-radius);
    border: 1px solid #e9ecef;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    overflow: hidden;
}
.summary-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}

.summary-card-header {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    gap: 1rem;
    cursor: pointer;
}

.summary-user-icon {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--secondary-light);
    color: var(--secondary-color);
}
.summary-user-icon svg {
    width: 24px;
    height: 24px;
}

.summary-info {
    flex-grow: 1;
}
.summary-info p { margin: 0; line-height: 1.4; }
.summary-info strong { color: var(--primary-color); font-size: 1.1rem; }

.summary-total-section {
    text-align: right;
    flex-shrink: 0;
}
.summary-total-section p { font-size: 0.8rem; color: #7f8c8d; margin: 0; }
.summary-total-section .total-amount {
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--success-color);
}

.summary-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-left: 1rem;
}

.summary-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease-in-out;
    background: #f8f9fa;
}
.summary-details-content {
    padding: 0.5rem 1.5rem 1.5rem 1.5rem;
    border-top: 1px solid #e9ecef;
}

.summary-bill-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.summary-bill-item {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-radius: 6px;
    background-color: var(--white);
    margin-top: 0.5rem;
    border: 1px solid #eee;
}
.summary-bill-item .date { color: #7f8c8d; font-size: 0.9em; }
.summary-bill-item .amount { font-weight: 600; color: var(--primary-color); }
/* Add this media query at the end of your <style> block */
@media (max-width: 576px) {
    .summary-card-header {
        flex-wrap: wrap; /* Allows items to wrap to the next line */
        padding: 0.75rem 1rem;
        row-gap: 0.75rem; /* Adds space when items wrap */
    }

    .summary-info {
        /* Ensures the info section is properly sized next to the icon */
        flex-basis: calc(100% - 48px - 1rem); 
        min-width: 150px;
    }
    
    .summary-total-section {
        flex-grow: 1; /* Allows total to take up available space on the second line */
        text-align: left; /* Aligns the total to the left */
    }

    .summary-actions {
        margin-left: 0; /* Removes the fixed margin to allow for better alignment */
    }

    .modal-content.modal-lg {
        /* Adjusts the modal itself for a better fit on mobile */
        margin: 5% auto;
        width: 95%;
        padding: 15px;
    }
}
    </style>
</head>
<body>
    <div id="login-page" class="no-print">
        <ul class="background-shapes">
            <li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li>
        </ul>
        <div id="login-box">
            <img src="https://anadisevaprakalp.org/wp-content/uploads/elementor/thumbs/anadi-farm-logo-2nd-copy-png-f-pf3gkbrok4it2hn25dsym3ek5sdjquv18uov85lvww.png" alt="Anadi Farms Logo" id="login-logo">
            <h1>Billing System Login</h1>
            <div class="input-field">
                <input type="text" id="username" required placeholder=" ">
                <label for="username">Enter Your Name</label>
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg></span>
            </div>
            <div class="input-field">
                <input type="password" id="password" required placeholder=" ">
                <label for="password">Enter Password</label>
                <span class="icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2m3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2M5 9a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1z"/></svg></span>
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Login</button>
        </div>
    </div>
    
    <div id="main-page" class="no-print">
        <header>
            <h2>Anadi Billing System</h2>
            <nav>
                <button id="nav-billing" class="active" onclick="showTab('billing')">Billing</button>
                <button id="nav-history" onclick="showTab('history')">History</button>
            </nav>
        </header>
        <div class="container">
            <div id="billing-tab" class="tab active">
                 <div class="form-section">
                     <h3>Customer Details</h3>
                     <div class="form-grid customer-grid">
                         <input type="text" id="cust-name" placeholder="Name">
                         <input type="tel" id="cust-phone" placeholder="Phone Number">
                         <input type="text" id="cust-house" placeholder="House No / Address">
                     </div>
                 </div>
                 <div class="form-section">
                     <h3>Product Details</h3>
                     <div class="product-entry-grid">
                         <input type="text" id="product-name" placeholder="Product Name">
                         <input type="number" id="product-qty" placeholder="Qty" min="0.001" step="0.001">
                         <input type="number" id="product-price" placeholder="Price" min="0">
                         <button class="btn btn-secondary" onclick="addItemToCart()">Add Item</button>
                     </div>
                     <table id="cart-table">
                         <thead><tr><th>Product</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                         <tbody></tbody>
                     </table>
                 </div>
                 <div class="action-buttons-container">
                     <button class="btn btn-warning" onclick="clearCart()">Clear Cart</button>
                     <button class="btn btn-success" onclick="generateBill()">Generate Bill</button>
                 </div>
            </div>

            <div id="history-tab" class="tab">
                <div class="history-controls form-section">
                     <input type="text" id="historySearchInput" placeholder="Search by Name, Phone, or Bill ID..." oninput="renderHistory()">
                     <div class="controls-group">
                        <button class="action-btn" title="Update Status by QR/Manual" onclick="openDispatchModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41M12 1a2 2 0 0 0-2 2v2H1a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h11.5a.5.5 0 0 0 0-1H1.5a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5H10V3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-1a.5.5 0 0 0 0 1h1a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2zM0 11.5a.5.5 0 0 1 .5-.5h15a.5.5 0 0 1 0 1h-15a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h4.5a.5.5 0 0 0 0-1z"/></svg>
                        </button>
                        <button class="action-btn" title="Customer Summary" onclick="openSummaryModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M1.5 2.5a.5.5 0 0 0 0 1h13a.5.5 0 0 0 0-1zM1 4.5a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5m1.5 2.5a.5.5 0 0 0 0 1h10a.5.5 0 0 0 0-1zm-1.5 3a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1zM11 9.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1h-2a.5.5 0 0 1-.5-.5m-1.5 3a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z"/></svg>
                        </button>
                        <button class="action-btn" title="Export History to PDF" onclick="exportPdfReport()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg>
                        </button>
                     </div>
                </div>
                <div id="bill-history-container"></div>
            </div>
        </div>
    </div>

    <div id="billModal" class="modal no-print"><div class="modal-content"><span class="close-btn" onclick="closeBillModal()">&times;</span><h2 id="bill-id-display-modal"></h2><div id="qrcode-modal" style="margin: 20px 0;"></div><div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;"><button class="btn btn-primary" onclick="window.print()">Print Bill</button><button class="btn btn-secondary" onclick="saveAsPdf()">Export to PDF</button></div></div></div>
    <div id="dispatchModal" class="modal no-print"><div class="modal-content"><span class="close-btn" onclick="closeDispatchModal()">&times;</span><h2>Update Bill Status</h2><div id="qr-reader" style="width:100%;"></div><div class="manual-dispatch-box"><input type="number" class="btn" style="background:white; color:rgb(0, 0, 0); border:1px solid #ccc" id="billIdInput" placeholder="Or Enter Code Manually"><button class="btn btn-success" onclick="handleManualDispatch()">Dispatch</button></div><br></div></div>
    <div id="summaryModal" class="modal no-print"><div class="modal-content modal-lg"><span class="close-btn" onclick="closeSummaryModal()">&times;</span><h2>Bill summery</h2><div id="summary-list-container"></div></div></div>
    <div id="printable-area" class="print-only"><div id="print-content"><h2>Anadi Industries LLP</h2><p class="center"> Ballabhgarh Sohna Road, Pali Village, Faridabad Haryana 121004</p><hr><div id="print-cust-details"></div><hr><table id="print-items-table"></table><hr><h3 id="print-total"></h3><img id="print-qr-img" alt="QR Code"><p class="center">Thank you for your visit!</p></div></div>
    <div id="toastContainer" class="no-print"></div>

   <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxDDQIYRxckNTApoAV8qoEj97xJA_yUaJd30qlp_TY0kPCMFGimwprOQ-jBfgqwxJHa/exec';
    let cart = [], bills = [], html5QrCode, currentBill = null;
    let customerSummaryData = {};
    const whatsappIcon = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16.75,13.96C17.08,14.39 17.21,15.04 17.04,15.54C16.87,16.03 16.46,16.35 15.98,16.5C15.5,16.65 14.88,16.63 14.24,16.39C13.6,16.15 12.38,15.61 11.23,14.45C9.88,13.1 9.05,11.56 8.84,10.93C8.64,10.3 8.8,9.7 9.09,9.29C9.33,8.95 9.68,8.76 10,8.76C10.33,8.76 10.5,8.76 10.63,8.76C10.85,8.76 11.03,8.81 11.21,9.23L11.75,10.5C11.9,10.88 11.91,11.21 11.8,11.48C11.68,11.75 11.53,11.9 11.28,12.15C11.04,12.4 10.9,12.54 10.76,12.68C10.63,12.82 10.48,13.01 10.75,13.28C11.02,13.55 11.63,14.15 12.28,14.81C13.11,15.63 13.75,15.94 14.05,16.09C14.35,16.24 14.58,16.21 14.78,16.03L15.3,15.5C15.68,15.13 16.11,15 16.5,15.03C16.88,15.06 17.63,15.33 17.63,15.33L18.03,13.93C17.76,13.81 17.26,13.55 16.75,13.96M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22C13.66,22 15.25,21.54 16.65,20.73L21.35,22.14L20.06,17.5C21.06,16 21.75,14.11 21.94,12.1C22,11.95 22,11.97 22,12A10,10 0 0,0 12,2Z"/></svg>`;

    document.addEventListener('DOMContentLoaded', async () => {
        showToast("Loading history from database...");
        await loadBills();
        renderHistory();
        const productNameInput = document.getElementById('product-name');
        const productQtyInput = document.getElementById('product-qty');
        const productPriceInput = document.getElementById('product-price');
        productNameInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); productQtyInput.focus(); } });
        productQtyInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); productPriceInput.focus(); } });
        productPriceInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addItemToCart(); productNameInput.focus(); } });
    });

    async function updateBillOnServer(action, payload) {
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action, payload }) });
        } catch (error) {
            console.error('Sync Error:', error);
            throw new Error("Failed to sync with the server.");
        }
    }
    
    async function loadBills() {
        try {
            const response = await fetch(SCRIPT_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            bills = await response.json();
            showToast("History loaded successfully!", "success");
        } catch (error) {
            console.error('Failed to load bills:', error);
            showToast("Could not load history from database.", "error");
            bills = []; 
        }
    }
    
    function generateBill() {
        const custName = document.getElementById('cust-name').value.trim();
        const custPhone = document.getElementById('cust-phone').value.trim();
        const custHouse = document.getElementById('cust-house').value.trim();
        if (!custName || !custPhone || !custHouse) return showToast("Please fill customer details", "error");
        if (cart.length === 0) return showToast("Cart is empty", "error");
        const bill = {
            id: Math.floor(10000 + Math.random() * 90000),
            customer: { name: custName, phone: custPhone, house: custHouse },
            items: [...cart],
            total: cart.reduce((sum, item) => sum + item.total, 0),
            date: new Date().toLocaleString('en-IN', {day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true}),
            status: 'pending',
            paymentStatus: 'unpaid'
        };
        currentBill = bill;
        bills.unshift(bill);
        showToast(`Bill #${bill.id} Generated! Saving...`);
        openBillModal(bill);
        updateBillOnServer('addBill', bill)
            .catch(error => {
                showToast(`Failed to save Bill #${bill.id}.`, "error");
                bills = bills.filter(b => b.id !== bill.id);
                renderHistory();
            });
        cart = []; 
        updateCartTable();
        ['cust-name', 'cust-phone', 'cust-house'].forEach(id => document.getElementById(id).value = '');
    }
    
    async function openBillModal(bill) {
        document.getElementById('bill-id-display-modal').innerText = `Unique Code: ${bill.id}`;
        try {
            const canvas = await QRCode.toCanvas(document.createElement('canvas'), JSON.stringify({ billId: bill.id }));
            const qrcodeContainer = document.getElementById('qrcode-modal');
            qrcodeContainer.innerHTML = ''; qrcodeContainer.appendChild(canvas);
            preparePrintableArea(bill, canvas.toDataURL());
        } catch (err) { console.error(err); }
        document.getElementById('billModal').style.display = 'block';
    }

    function closeBillModal() { document.getElementById('billModal').style.display = 'none'; }
    function closeDispatchModal() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch((err) => console.error("Failed to stop scanner.", err));
        }
        document.getElementById('dispatchModal').style.display = 'none';
    }
    function closeSummaryModal() { document.getElementById('summaryModal').style.display = 'none'; }

    function markAsDispatched(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill || bill.status === 'dispatched') return;
        const originalStatus = bill.status;
        bill.status = 'dispatched';
        renderHistory();
        showToast(`Bill #${billId} marked as Dispatched!`, "success");
        setTimeout(() => sendWhatsApp(billId), 500);
        updateBillOnServer('updateStatus', { billId: billId, status: 'dispatched' })
            .catch(error => {
                showToast(`Sync failed for Bill #${billId}. Reverting.`, "error");
                bill.status = originalStatus; renderHistory();
            });
    }
    
    function togglePaymentStatus(billId, isChecked) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        const originalPaymentStatus = bill.paymentStatus;
        const newPaymentStatus = isChecked ? 'paid' : 'unpaid';
        bill.paymentStatus = newPaymentStatus;
        renderHistory();
        showToast(`Bill #${billId} marked as ${newPaymentStatus}.`, "success");
        updateBillOnServer('updateStatus', { billId: billId, paymentStatus: newPaymentStatus })
            .catch(error => {
                showToast(`Sync failed for Bill #${billId}. Reverting.`, "error");
                bill.paymentStatus = originalPaymentStatus; renderHistory();
            });
    }
    
    function deleteBill(billId) {
        if (!confirm(`Are you sure you want to delete bill #${billId}?`)) return;
        const billIndex = bills.findIndex(b => b.id === billId);
        if (billIndex === -1) return;
        const deletedBill = bills[billIndex];
        bills.splice(billIndex, 1);
        renderHistory();
        showToast(`Bill #${billId} deleted.`, 'error');
        updateBillOnServer('deleteBill', { billId: billId })
            .catch(error => {
                showToast(`Could not delete Bill #${billId} from server.`, "error");
                bills.splice(billIndex, 0, deletedBill); renderHistory();
            });
    }
    
    // REPLACE this function
function openSummaryModal() {
    generateCustomerSummary();
    const container = document.getElementById('summary-list-container');
    const summaryValues = Object.values(customerSummaryData).sort((a, b) => b.totalAmount - a.totalAmount); // Sort by total amount

    const userIcon = `<svg xmlns="http://www.w.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/></svg>`;
    const expandIcon = `‚ñº`; // Using a simple character for the icon

    if (summaryValues.length === 0) {
        container.innerHTML = `<p style="text-align: center; padding: 2rem 0;">No customer history found.</p>`;
    } else {
        container.innerHTML = summaryValues.map(summary => {
            const chronologicalBills = [...summary.allBills].reverse();
            return `
            <div class="summary-card">
                <div class="summary-card-header" onclick="toggleSummaryDetails(this)">
                    <div class="summary-user-icon">${userIcon}</div>
                    <div class="summary-info">
                        <p><strong>${summary.customerInfo.name}</strong></p>
                        <p>${summary.customerInfo.phone}</p>
                    </div>
                    <div class="summary-total-section">
                        <p>Total Purchase</p>
                        <span class="total-amount">‚Çπ${summary.totalAmount.toFixed(2)}</span>
                    </div>
                    <div class="summary-actions">
                        <button class="action-btn whatsapp-btn" title="Send Summary on WhatsApp" onclick="event.stopPropagation(); sendSummaryWhatsApp('${summary.customerInfo.phone}')">${whatsappIcon}</button>
                        <button class="action-btn expand-btn" title="View Details">${expandIcon}</button>
                    </div>
                </div>
                <div class="summary-details">
                    <div class="summary-details-content">
                        <h4>Purchase History (${chronologicalBills.length} Bills)</h4>
                        <ul class="summary-bill-list">
                            ${chronologicalBills.map(bill => `
                                <li class="summary-bill-item">
                                    <div>
                                        <strong>Bill #${bill.id}</strong>
                                        <span class="date">${bill.date}</span>
                                    </div>
                                    <span class="amount">‚Çπ${bill.total.toFixed(2)}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            </div>`;
        }).join('');
    }
    document.getElementById('summaryModal').style.display = 'block';
}

// ADD this new function
function toggleSummaryDetails(headerElement) {
    const card = headerElement.closest('.summary-card');
    const detailsDiv = card.querySelector('.summary-details');
    const expandBtn = card.querySelector('.expand-btn');
    const isExpanded = detailsDiv.style.maxHeight && detailsDiv.style.maxHeight !== "0px";

    if (isExpanded) {
        detailsDiv.style.maxHeight = "0px";
        expandBtn.style.transform = 'rotate(0deg)';
    } else {
        const content = detailsDiv.querySelector('.summary-details-content');
        detailsDiv.style.maxHeight = content.scrollHeight + 40 + "px"; // 40px for padding
        expandBtn.style.transform = 'rotate(180deg)';
    }
}

    function generateCustomerSummary() {
        customerSummaryData = {};
        bills.forEach(bill => {
            const phone = bill.customer.phone;
            if (!customerSummaryData[phone]) {
                customerSummaryData[phone] = { customerInfo: bill.customer, totalAmount: 0, allBills: [] };
            }
            customerSummaryData[phone].allBills.push(bill);
            customerSummaryData[phone].totalAmount += bill.total;
        });
    }

    function sendSummaryWhatsApp(phone) {
        const summary = customerSummaryData[phone];
        if (!summary) return;
        let message = `*Purchase Summary for ${summary.customerInfo.name}*\n\n*Name:* ${summary.customerInfo.name}\n*Phone:* ${summary.customerInfo.phone}\n*Address:* ${summary.customerInfo.house}\n------------------------------------\n\n`;
        const chronologicalBills = [...summary.allBills].reverse();
        chronologicalBills.forEach(bill => {
            message += `*Bill #${bill.id}* (${bill.date})\n`;
            bill.items.forEach(item => { message += `- ${item.name} (Qty: ${item.qty}, Price: ‚Çπ${item.price.toFixed(2)})\n`; });
            message += `_Bill Total: ‚Çπ${bill.total.toFixed(2)}_\n\n`;
        });
        message += `------------------------------------\n*GRAND TOTAL: ‚Çπ${summary.totalAmount.toFixed(2)}*\n\nThank you for shopping with us!`;
        const formattedPhone = formatPhoneNumberForWhatsApp(phone);
        const encodedMessage = encodeURIComponent(message);
        window.open(`https://wa.me/${formattedPhone}?text=${encodedMessage}`, "_blank");
    }

    function handleLogin() {
        const username = document.getElementById('username').value, password = document.getElementById('password').value;
        if (!username.trim()) return showToast("Please enter your name", "error");
        if (password === "anadi") {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-page').style.display = 'block';
            showToast(`Welcome, ${username}!`);
        } else { showToast("Incorrect Password", "error"); }
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`${tabId}-tab`).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(`nav-${tabId}`).classList.add('active');
        if (tabId === 'history') renderHistory();
    }

    function addItemToCart() {
        const name = document.getElementById('product-name').value.trim(),
              qty = parseFloat(document.getElementById('product-qty').value),
              price = parseFloat(document.getElementById('product-price').value);
        if (!name || isNaN(qty) || isNaN(price) || qty <= 0 || price < 0) return showToast("Please fill all product fields correctly", "error");
        cart.push({ name, qty, price, total: qty * price });
        updateCartTable();
        ['product-name', 'product-qty', 'product-price'].forEach(id => document.getElementById(id).value = '');
    }

    function updateCartTable() {
        const tbody = document.querySelector('#cart-table tbody');
        tbody.innerHTML = ''; let grandTotal = 0;
        cart.forEach((item) => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${item.name}</td><td>${item.qty}</td><td>‚Çπ${item.price.toFixed(2)}</td><td>‚Çπ${item.total.toFixed(2)}</td>`;
            tbody.appendChild(row); grandTotal += item.total;
        });
        if (cart.length > 0) {
            const totalRow = document.createElement('tr');
            totalRow.style.fontWeight = "bold";
            totalRow.innerHTML = `<td colspan="3">Grand Total</td><td>‚Çπ${grandTotal.toFixed(2)}</td>`;
            tbody.appendChild(totalRow);
        }
    }

    function clearCart() {
        if (cart.length > 0 && confirm("Are you sure you want to clear the entire cart?")) {
            cart = []; updateCartTable(); showToast("Cart cleared!", "error");
        }
    }

    function saveAsPdf() {
        if (!currentBill) return showToast("No bill has been generated to save.", "error");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'portrait', unit: 'in', format: [4, 6] });
        const margin = 0.25, pageWidth = 4, pageHeight = 6, contentWidth = pageWidth - (margin * 2);
        let y = margin;
        doc.setFontSize(16); doc.setFont('helvetica', 'bold');
        doc.text('Anadi Industries LLP', pageWidth / 2, y, { align: 'center' });
        y += 0.2; doc.setFontSize(8); doc.setFont('helvetica', 'normal');
        doc.text('Ballabhgarh Sohna Road, Pali Village, Faridabad Haryana 121004', pageWidth / 2, y, { align: 'center', maxWidth: contentWidth });
        y += 0.25; doc.setLineWidth(0.01); doc.line(margin, y, pageWidth - margin, y); y += 0.2;
        doc.setFontSize(10); doc.setFont('helvetica', 'bold');
        doc.text('Bill To:', margin, y); doc.setFont('helvetica', 'normal');
        doc.text(currentBill.customer.name, margin + 0.6, y); y += 0.2;
        doc.setFont('helvetica', 'bold');
        doc.text('Phone:', margin, y); doc.setFont('helvetica', 'normal');
        doc.text(currentBill.customer.phone, margin + 0.6, y); y += 0.2;
        doc.setFont('helvetica', 'bold');
        doc.text('Address:', margin, y); doc.setFont('helvetica', 'normal');
        const addressLines = doc.splitTextToSize(currentBill.customer.house, contentWidth - 0.7);
        doc.text(addressLines, margin + 0.6, y); y += (addressLines.length * 0.18) + 0.1;
        doc.setFont('helvetica', 'bold');
        doc.text(`Bill ID: ${currentBill.id}`, margin, y);
        doc.text(`Date: ${currentBill.date}`, pageWidth - margin, y, { align: 'right' });
        y += 0.2; doc.line(margin, y, pageWidth - margin, y);
        const tableHead = [['Item', 'Qty', 'Price (Rs)', 'Amount (Rs)']];
        const tableBody = currentBill.items.map(item => [item.name, item.qty, item.price.toFixed(2), item.total.toFixed(2)]);
        doc.autoTable({ head: tableHead, body: tableBody, startY: y + 0.1, theme: 'striped', headStyles: { fillColor: [240, 240, 240], textColor: 20, fontStyle: 'bold' }, styles: { fontSize: 9, cellPadding: 0.07 }, columnStyles: { 1: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center' } }, margin: { left: margin, right: margin } });
        y = doc.autoTable.previous.finalY;
        y += 0.3; doc.setFontSize(14); doc.setFont('helvetica', 'bold');
        doc.text(`Grand Total: Rs ${currentBill.total.toFixed(2)}`, pageWidth - margin, y, { align: 'right' });
        const qrImgData = document.getElementById('print-qr-img').src;
        const qrSize = 1.2, qrX = (pageWidth - qrSize) / 2, qrY = pageHeight - margin - qrSize - 0.3;
        if (y < qrY) {
             doc.addImage(qrImgData, 'PNG', qrX, qrY, qrSize, qrSize);
             doc.setFontSize(9); doc.setFont('helvetica', 'italic');
             doc.text('Thank you for your visit!', pageWidth / 2, pageHeight - margin - 0.1, { align: 'center' });
        }
        try {
            doc.save(`bill-${currentBill.id}.pdf`);
            showToast("PDF export started!", "success");
        } catch(err) { showToast("Could not export PDF file.", "error"); }
    }

    function preparePrintableArea(bill, qrDataUrl) {
        document.getElementById('print-cust-details').innerHTML = `<p><strong>Bill To:</strong> ${bill.customer.name}</p><p><strong>Phone:</strong> ${bill.customer.phone}</p><p><strong>Address:</strong> ${bill.customer.house}</p><p><strong>Date:</strong> ${bill.date}</p><p><strong>Bill ID:</strong> ${bill.id}</p>`;
        const itemsTbody = bill.items.map(i => `<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.total.toFixed(2)}</td></tr>`).join('');
        document.getElementById('print-items-table').innerHTML = `<thead><tr><th>Item</th><th>Qty</th><th>Amt</th></tr></thead><tbody>${itemsTbody}</tbody>`;
        document.getElementById('print-total').innerText = `Total: ‚Çπ${bill.total.toFixed(2)}`;
        document.getElementById('print-qr-img').src = qrDataUrl;
    }

    function renderHistory() {
        const searchTerm = document.getElementById('historySearchInput').value.toLowerCase();
        const filteredBills = bills.filter(bill =>
            bill.customer.name.toLowerCase().includes(searchTerm) ||
            bill.customer.phone.toString().includes(searchTerm) ||
            bill.id.toString().includes(searchTerm)
        );
        const container = document.getElementById('bill-history-container');
        container.innerHTML = filteredBills.length === 0 ? '<p style="text-align:center;">No bills found.</p>' : '';
        filteredBills.forEach(bill => {
            const card = document.createElement('div');
            card.className = `bill-card ${bill.status}`;
            card.innerHTML = `<div class="bill-card-main" onclick="toggleDetails(this, ${bill.id})"><div class="bill-info bill-id"><h4>#${bill.id}</h4><span class="bill-status-badge ${bill.status}">${bill.status}</span></div><div class="bill-info bill-customer"><p><strong>${bill.customer.name}</strong></p><p>${bill.customer.phone}</p></div><div class="bill-info bill-total"><h4>‚Çπ${bill.total.toFixed(2)}</h4><span class="payment-status ${bill.paymentStatus}">${bill.paymentStatus.toUpperCase()}</span></div></div><div class="bill-card-actions"><div class="payment-toggle-container" title="Toggle Payment Status" onclick="event.stopPropagation()"><span>Payment:</span><input type="checkbox" id="pay-toggle-${bill.id}" class="payment-toggle" onchange="togglePaymentStatus(${bill.id}, this.checked)" ${bill.paymentStatus === 'paid' ? 'checked' : ''}><label for="pay-toggle-${bill.id}" class="payment-toggle-label"></label></div><button class="action-btn whatsapp-btn" title="Send on WhatsApp" onclick="sendWhatsApp(${bill.id})">${whatsappIcon}</button><button class="action-btn delete-btn" title="Delete Bill" onclick="deleteBill(${bill.id})">üóëÔ∏è</button><button class="action-btn expand-btn" title="View Details" onclick="toggleDetails(this.parentElement.previousElementSibling, ${bill.id})">‚ñº</button></div><div class="bill-details"><div class="bill-details-content"></div></div>`;
            container.appendChild(card);
        });
    }
    
    function toggleDetails(headerElement, billId) {
        const card = headerElement.closest('.bill-card');
        const expandBtn = card.querySelector('.expand-btn');
        const detailsDiv = card.querySelector('.bill-details');
        const isExpanded = detailsDiv.style.maxHeight && detailsDiv.style.maxHeight !== "0px";
        if (isExpanded) {
            detailsDiv.style.maxHeight = "0px";
            expandBtn.classList.remove('expanded');
        } else {
            const bill = bills.find(b => b.id === billId);
            const content = detailsDiv.querySelector('.bill-details-content');
            content.innerHTML = `<p><strong>Address:</strong> ${bill.customer.house}</p><strong>Items:</strong><ul>${bill.items.map(i => `<li>${i.name} (Qty: ${i.qty}) - ‚Çπ${i.total.toFixed(2)}</li>`).join('')}</ul>`;
            detailsDiv.style.maxHeight = content.scrollHeight + 40 + "px";
            expandBtn.classList.add('expanded');
        }
    }
    
    function handleManualDispatch() {
        const id = parseInt(document.getElementById('billIdInput').value);
        if(!isNaN(id)) markAsDispatched(id);
        document.getElementById('billIdInput').value = '';
    }

    function formatPhoneNumberForWhatsApp(phone) {
        let cleaned = phone.toString().replace(/\D/g, '');
        if (cleaned.startsWith('0')) cleaned = cleaned.substring(1);
        if (cleaned.length === 10) return '91' + cleaned;
        return cleaned;
    }

    function sendWhatsApp(billId) {
        const bill = bills.find(b => b.id === billId);
        if (!bill) return;
        const formattedPhone = formatPhoneNumberForWhatsApp(bill.customer.phone);
        const itemsText = bill.items.map(i => `${i.name} (Qty: ${i.qty}) - ‚Çπ${i.total.toFixed(2)}`).join('%0A');
        const message = `*Bill Details*%0A%0ABill ID: *${bill.id}*%0ACustomer: *${bill.customer.name}*%0ADispatch Status: *${bill.status.toUpperCase()}*%0APayment Status: *${bill.paymentStatus.toUpperCase()}*%0A%0A--- Items ---%0A${itemsText}%0A%0ATotal Amount: *‚Çπ${bill.total.toFixed(2)}*`;
        window.open(`https://wa.me/${formattedPhone}?text=${message}`, "_blank");
    }
    
    function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`; toast.textContent = message;
        toast.style.animation = 'line-to-box-in 0.6s ease-out forwards';
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'line-to-box-out 0.6s ease-in forwards';
            setTimeout(() => { toast.remove(); }, 600);
        }, 4400);
    }

    function openDispatchModal() {
        if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop().catch(err => console.error(err)); }
        document.getElementById('dispatchModal').style.display = 'block';
        html5QrCode = new Html5Qrcode("qr-reader");
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            try {
                const data = JSON.parse(decodedText);
                if (data.billId) { markAsDispatched(data.billId); closeDispatchModal(); }
            } catch (e) { showToast("Invalid QR Code.", "error"); }
        };
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, qrCodeSuccessCallback)
            .catch((err) => { document.getElementById('qr-reader').innerHTML = '<p style="color: red; font-weight: bold;">Could not start camera.</p>'; });
    }

    // REPLACE your existing exportPdfReport function with this one
function exportPdfReport() {
    if (bills.length === 0) return showToast("No bills to export to PDF.", "error");
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
    
    // The headers for your PDF table
    const headers = [["Sr.", "Customer Name", "Phone", "Address", "Product", "Qty", "Price", "Total", "Date", "Dispatch Status", "Payment Status"]];
    
    const reportData = []; 
    let serialNumber = 1, grandTotal = 0;

    // Loop through bills and format the data for the PDF
    bills.forEach(bill => {
        // --- FIX 1: Format the date properly ---
        // Create a clean, readable date string from the raw date data
        const formattedDate = new Date(bill.date).toLocaleString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });

        bill.items.forEach(item => {
            reportData.push([
                serialNumber++,
                bill.customer.name,
                bill.customer.phone,
                bill.customer.house,
                item.name,
                item.qty,
                `Rs ${item.price.toFixed(2)}`,
                `Rs ${item.total.toFixed(2)}`,
                formattedDate, // Use the new formatted date here
                bill.status,
                bill.paymentStatus
            ]);
            grandTotal += item.total;
        });
    });

    doc.setFontSize(18); 
    doc.setFont('helvetica', 'bold');
    doc.text("Anadi Industries - Bill Report", 40, 40);

    doc.autoTable({
        head: headers,
        body: reportData,
        startY: 60,
        theme: 'grid',
        styles: { fontSize: 7, cellPadding: 4 },
        headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold' },
        // --- FIX 2: Adjust column widths to prevent wrapping ---
        columnStyles: {
            0: { cellWidth: 30 },   // Sr.
            3: { cellWidth: 120 },  // Address
            4: { cellWidth: 90 },   // Product
            8: { cellWidth: 90 },   // Date
            9: { cellWidth: 60 },   // Dispatch Status
            10: { cellWidth: 60 },  // Payment Status
            // Right-align number columns
            5: { halign: 'right' },
            6: { halign: 'right' },
            7: { halign: 'right' }
        }
    });

    let finalY = doc.autoTable.previous.finalY;
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(`Grand Total: Rs ${grandTotal.toFixed(2)}`, 40, finalY + 30);

    try {
        doc.save(`Bill_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        showToast("PDF export started!", "success");
    } catch(err) {
        showToast("Could not export PDF file.", "error");
    }
}
   </script>
</body>
</html>
